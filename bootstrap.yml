- name: Bootstrap development environment
  hosts: localhost

  tasks:
    - name: Install cask packages with brew
      become: no
      community.general.homebrew_cask:
        name:
          - wezterm
          - font-fira-code-nerd-font
          - font-meslo-lg-nerd-font
          - font-symbols-only-nerd-font


    - name: Install regular packages with brew
      become: no
      community.general.homebrew:
        name:
          # neovim
          - nvim
          # Programming Languages
          - asdf
          # git 
          - git
          - lazygit
          - forgit
          # tmux
          - tmux
          - reattach-to-user-namespace
          - joshmedeski/sesh/sesh
          # yazi dependencies
          - yazi
          - ffmpegthumbnailer # ffmpeg thumbnails for yazi
          - poppler # pdf rendering library
          # Docker dependencies
          - colima
          - docker
          - kubectl 
          - kubectx
          - k9s
          # Command Line Utilities
          - fd
          - ripgrep
          - fzf
          - zoxide
          - rclone
          - unar
          - jq
          - watchexec
          - just
          - direnv
          - sheldon
          - stow
          - fzf
          - ripgrep
          - the_silver_searcher
          - pv
          - gum
          - hyperfine
        state: present
        upgrade_all: false
      when: ansible_distribution == "MacOSX"
 
    # TODO: better changed_when
    # Install fzf 
    - name: install fzf
      shell: 
        cmd: "$(brew --prefix)/opt/fzf/install --all"
      changed_when: False

    # Oh My tmux
    - name: Setup tmux
      become: no
      ansible.builtin.git:
        depth: 1
        dest: ~/.tmux
        repo: https://github.com/gpakosz/.tmux.git

    - name: Symlink tmux
      ansible.builtin.file:
        state: "link"
        src: ~/.tmux/.tmux.conf
        dest: ~/.tmux.conf

    - name: Run stow
      shell: 
        cmd: "stow {{ item }} --target {{ ansible_env.HOME }} --verbose=2"
      register: result
      changed_when: 'result.stderr is search("LINK: ")'
      loop: 
        - neovim
        - tmux
        - zsh
        - wezterm
